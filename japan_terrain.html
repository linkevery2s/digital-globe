<!DOCTYPE HTML>
<html lang="ja">
<title>日本の3D地形</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000000;
    }

    html {
      font-family: "Meiryo", "Hiragino Maru Gothic Pro", sans-serif;
    }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MPP84V2NHB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MPP84V2NHB');
  </script>

</head>

<body>

  <script type="module">
    import { deck } from 'https://code4fukui.github.io/deck-es/deck.js';
    import { GsiTerrainLayer } from "https://code4fukui.github.io/deckgl-gsi-terrain-layer/index.js";

    // 地理院タイル
    const TERRAIN_IMAGE = 'https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png';
    const SURFACE_IMAGE = 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg';

    // RGB標高変換パラメータ
    const ELEVATION_DECODER = {
      scaler: 0.03,
      offset: 0
    };

    const layer = new GsiTerrainLayer({
      id: 'gsiTerrain',
      minZoom: 0,
      maxZoom: 20,
      elevationDecoder: ELEVATION_DECODER,
      elevationData: TERRAIN_IMAGE,
      texture: SURFACE_IMAGE,
    });

    const offices = new deck.ScenegraphLayer({
      id: 'scenegraph-layer',
      data: "./data/prefectures.json",
      pickable: true,
      scenegraph: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoxAnimated/glTF-Binary/BoxAnimated.glb',
      getPosition: d => [Number(d.lng), Number(d.lat)],
      getOrientation: d => [0, Math.random() * 180, 90],
      _animations: { '*': { speed: 5 } },
      sizeScale: 3000,
      _lighting: 'pbr'
    });

    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      const html_tr = ["<table>", "都道府県名：" + obj.prefectures + "<br>県庁所在地：" + obj.offices, "</table>"].join("\n");

      return {
        html: html_tr,
        style: {
          background: "rgba(255,255,255,0.7)",
          color: "#000000"
        }
      };
    };

    const INITIAL_VIEW_STATE = {
      longitude: 139.779,
      latitude: 35.666,
      zoom: 8.5,
      minZoom: 3,
      pitch: 50,
      maxPitch: 85,
    };

    new deck.Deck({
      initialViewState: INITIAL_VIEW_STATE,
      onViewStateChange: ({ viewState }) => {

        //console.log(Math.round(viewState.zoom * 10) / 10 + "," + Math.round(viewState.latitude * 1000) / 1000 + "," + Math.round(viewState.longitude * 1000) / 1000);

        history.replaceState('','','/japan_terrain.html#!' + Math.round(viewState.latitude * 1000) / 1000 + "/" + Math.round(viewState.longitude * 1000) / 1000 + "/" + Math.round(viewState.zoom * 10) / 10 + "/" + Math.round(viewState.pitch) + "/" + Math.round(viewState.bearing));

      },
      controller: {
        touchRotate: true
      },
      getTooltip: tooltip,
      layers: [
        layer, offices
      ]
    });
  </script>
</body>

</html>
